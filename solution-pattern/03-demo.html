<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solution Pattern: App Connectivity with Policy-as-Code :: Solution Patterns from Red Hat</title>
    <link rel="canonical" href="https://solution.io/solution-pattern/03-demo.html">
    <link rel="prev" href="02-architecture.html">
    <link rel="next" href="04-workshop.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">

<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const managedzone = urlParams.get('MANAGEDZONE');
      const subdomain = urlParams.get('SUBDOMAIN'); 
      if (managedzone) {
        showManagedZone( managedzone, subdomain);
      }
      else {
        showManagedZoneForm(subdomain);
      }
    } );


    function showManagedZone( managedzone, subdomain) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('managedZoneDisplay').textContent = "Managed Zone : " + managedzone;
      document.getElementById('subdomainDisplay').textContent = "Subdomain : " + subdomain; 
    }

    function showManagedZoneForm( subdomain ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
      document.getElementById('subdomain').value = subdomain; 

    }

    function goWithManagedZone() {
      elManagedZoneInput = document.getElementById('managedzone');
      elSubdomainInput = document.getElementById('subdomain');
      window.location.search = ('&MANAGEDZONE=' + elManagedZoneInput.value  + '&SUBDOMAIN=' + elSubdomainInput.value);
    }

    function recycle() {
      document.getElementById('managedzone').value='';
      document.getElementById('subdomain').value='';
      window.location.search = ('');
    }


  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" style="font-size: 20px; color: white" href="https://solution.io">
        <img src="../_/img/logo.png" height="35px" alt="Solution Patterns">&nbsp; Solution Patterns from Red Hat</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Architectures &amp; Patterns</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/architect/portfolio/" target="_blank">Portfolio Architecture&nbsp; </a>
            <a class="navbar-item" href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html"  target="_blank">Solution Patterns </a>
            <a class="navbar-item" href="https://validatedpatterns.io/" target="_blank">Validated Patterns&nbsp;</a>
            <a class="navbar-item" href="https://catalog.redhat.com/solutions" target="_blank">Ecosystem Solutions&nbsp;</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://developers.redhat.com">Red Hat Developers</a>
            <a class="navbar-item" target="_blank" href="https://developers.redhat.com/app-dev-platform">App Dev Platform</a>
            <a class="navbar-item" target="_blank" href="https://www.redhat.com/en/products/application-foundations">Red Hat Application Services</a>
          </div>
        </div>

          <a class="navbar-item" target="_blank" href="https://github.com/redhat-solution-patterns/redhat-solution-patterns.github.io/issues">Feedback</a>
          <a class="navbar-item" target="_blank" href="https://redhat-solution-patterns.github.io/solution-patterns/contributors-guide.html">Contribute</a>

          <div class="navbar-item" >         
              <div id="navbar-form-empty">
                <span >
                  <span>
                    &nbsp;
                    <i style="color: orange;" class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                  </span>
                  Your Workshop Environment
                <form action="javascript:void(0);" onsu>
                  <input size="20" id="managedzone" type="text" placeholder="MANAGED ZONE">
                  <input size="20" id="subdomain" type="text" placeholder="SUBDOMAIN">
                  <button type="hidden" onclick="goWithManagedZone();">Set</button>
                </form>
                </span>
              </div>
        
              <div  id="navbar-form-filled" style="display: none;">
                <span>
                <span>
                  Your Workshop Environment
                    <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">
                    <i alt="Clear details" title="Clear details" onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i>
                    <br><span  id="managedZoneDisplay"></span> <span>|</span>
                <span id="subdomainDisplay"></span>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>

<div class="body">
<div class="nav-container" data-component="solution-pattern" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Connectivity Link</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#use-cases">1.1 Use cases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_story_behind_this_solution_pattern">1.2 The story behind this solution pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_solution">1.3 The solution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#tech_stack">2.1. Technology stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#in_depth">2.2. An in-depth look at the solution&#8217;s architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#more_tech">2.3. More about the technology stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_demonstration">3.1. Demonstration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#_run_the_demonstration">3.2. Run this demonstration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#_before_getting_started">3.3. Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#_installing_the_demo">3.4. Installing the demo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#_walkthrough_guide">3.5. Walkthrough guide</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-workshop.html">4. Workshop</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-workshop.html#_installing_the_workshop_environment">4.1. Installing the workshop environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-workshop.html#_before_getting_started">4.2. Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-workshop.html#_installing_the_environment">4.3. Installing the environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-workshop.html#deliver_wksp">4.4. Delivering the workshop</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="developer-resources.html">5. Developer Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html" target="_blank" rel="noopener">Explore Red Hat Solution Patterns</a></span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Connectivity Link</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Connectivity Link</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Connectivity Link</a></li>
    <li><a href="03-demo.html">3. See the Solution in Action</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/jayachristina/soln-pattern-appconnectivity-pac/edit/main/documentation/modules/ROOT/pages/03-demo.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Solution Pattern: App Connectivity with Policy-as-Code</h1>
<h1 id="_see_the_solution_in_action" class="sect0"><a class="anchor" href="#_see_the_solution_in_action"></a><a class="link" href="#_see_the_solution_in_action">See the Solution in Action</a></h1>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a><a class="link" href="#_prerequisites">1. Prerequisites</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run this demo, you will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You will need an OpenShift cluster with admin access</p>
</li>
<li>
<p>Access to AWS to be able to create Route53 domain names</p>
</li>
<li>
<p>Free tier of Redis database</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_create_managed_zone_on_aws"><a class="anchor" href="#_create_managed_zone_on_aws"></a><a class="link" href="#_create_managed_zone_on_aws">1.1. Create Managed Zone on AWS</a></h3>
<div class="paragraph">
<p>Refer: <a href="https://developers.redhat.com/articles/2024/06/12/getting-started-red-hat-connectivity-link-openshift#prerequisites" target="_blank" rel="noopener">Prerequisites on Red Hat Developers</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>In AWS Route53 add a hosted zone as a subdomain (for example, managed.mytopdomain.com) for the applications that you want to manage and secure with Connectivity Link.</p>
</li>
<li>
<p>Refer to the the <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-working-with.html" target="_blank" rel="noopener">AWS documentation</a> on Route53 for instructions on how to setup the hosted zone.</p>
</li>
<li>
<p>Make sure you will have to create NS records in the top domain hosted zone in order to be able to route traffic to the subdomain, as explained in <a href="https://repost.aws/knowledge-center/create-subdomain-route-53" target="_blank" rel="noopener">this article</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_redis"><a class="anchor" href="#_redis"></a><a class="link" href="#_redis">1.2. Redis</a></h3>
<div class="ulist">
<ul>
<li>
<p>You can sign up for a free tier of Redis Cloud. Sign up at <a href="https://app.redislabs.com/" target="_blank" rel="noopener">app.redislabs.com</a></p>
</li>
<li>
<p>Once a free DB is created, get the connection string.</p>
<div class="ulist">
<ul>
<li>
<p>Click on DB created, and click on Connect button show in the page</p>
<div class="imageblock">
<div class="content">
<img src="_images/redis-connection.png" alt="redis connection" width="40%">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>You will need only the connection string which will look like this</p>
<div class="paragraph">
<p><code>redis://default:<strong><strong></strong>@redis-xx<strong></strong></strong>.cxx.eu-central-1-1.ec2.redns.redis-cloud.com:10155</code></p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_personalize_the_instructions"><a class="anchor" href="#_personalize_the_instructions"></a><a class="link" href="#_personalize_the_instructions">2. Personalize the instructions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To personalize the rest of the instructions to your OpenShift environment,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the top-right of this page enter the following information under the <strong>Your Workshop Environment</strong> section</p>
<div class="ulist">
<ul>
<li>
<p><strong>MANAGEDZONE</strong> as per the new Managed Zone that your created in the previous step and</p>
</li>
<li>
<p><strong>Subdomain</strong> to match your OpenShift cluster</p>
</li>
</ul>
</div>
</li>
<li>
<p>Press enter or click on the Set button</p>
<div class="imageblock">
<div class="content">
<img src="_images/setup-instructions.png" alt="setup instructions">
</div>
</div>
</li>
<li>
<p>The menubar and the rest of this walkthrough guide will be updated with the username and subdomain as shown below</p>
<div class="imageblock">
<div class="content">
<img src="_images/setup-instructions-complete.png" alt="setup instructions complete">
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The subdomain would look something like this <code>apps.cluster-name.guid.subdomain.myopenshift.com</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_walkthrough_guide" class="sect0"><a class="anchor" href="#_walkthrough_guide"></a><a class="link" href="#_walkthrough_guide">Walkthrough guide</a></h1>
<div class="sect1">
<h2 id="_deploy_the_workshop"><a class="anchor" href="#_deploy_the_workshop"></a><a class="link" href="#_deploy_the_workshop">3. Deploy the workshop</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Clone the ansible script</p>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/rh-soln-pattern-connectivity-link/cl-install-ansible</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_deploy_the_operator_and_related_systems"><a class="anchor" href="#_deploy_the_operator_and_related_systems"></a><a class="link" href="#_deploy_the_operator_and_related_systems">3.1. Deploy the Operator and related systems</a></h3>
<div class="ulist">
<ul>
<li>
<p>Open the inventories/inventory.template file and update the variable variables. Save the file.</p>
</li>
</ul>
</div>
<details>
<summary class="title"><span class="underline">Click for details of inventory.template file</span></summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">ocp4_workload_connectivity_link_kuadrant_redis_url=&lt;redis URL you setup in the previous step&gt;


ocp4_workload_connectivity_link_aws_access_key=&lt;AWS_ACCESS_KEY_ID&gt;
ocp4_workload_connectivity_link_aws_secret_access_key=&lt;AWS_SECRET_ACCESS_KEY&gt;

ocp4_workload_connectivity_link_aws_managed_zone_id=&lt;Managed Zone ID - created in the previous step&gt;
# E.g.: Z12345677XYZ0FF0GBHIJ0

ocp4_workload_connectivity_link_aws_managed_zone_domain=&lt;Managed Zone domain - created in the previous step&gt;
# E.g.: managed.sandbox1585.opentlc.com

ocp4_workload_connectivity_link_aws_managed_zone_region=&lt;Managed Zone region - default region of your AWS setup&gt;
# E.g.: eu-central-1

ocp4_workload_connectivity_link_ingress_gateway_tls_issuer_email=&lt;your  address email for letsencrypt&gt;

ocp4_workload_connectivity_link_gateway_geo_code=&lt;gateway geo code&gt;
# E.g.: EU or US</code></pre>
</div>
</div>
</div>
</details>
<div class="ulist">
<ul>
<li>
<p>Run the Ansible script which will setup the RHCL Operator, Istio and Kuadrant system workloads</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>ansible-playbook playbooks/ocp4_workload_connectivity_link.yml  -e ACTION=create -i inventories/inventory.template</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_the_globex_application"><a class="anchor" href="#_deploy_the_globex_application"></a><a class="link" href="#_deploy_the_globex_application">3.2. Deploy the Globex application</a></h3>
<div class="ulist">
<ul>
<li>
<p>Run the Ansible script which will setup the Globex app.</p>
<div class="listingblock">
<div class="content">
<pre>cd ../demo-setup
ansible-playbook playbooks/globex.yml -e ACTION=create -e "ocp4_workload_cloud_architecture_workshop_mobile_gateway_url=https://globex-mobile.%MANAGEDZONE%"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">PLAY RECAP *********************************************************************************************************************************************************************
localhost                  : ok=37   changed=10   unreachable=0    failed=0    skipped=7    rescued=0    ignored=0</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deployment_walkthrough_as_a_platform_engineer"><a class="anchor" href="#_deployment_walkthrough_as_a_platform_engineer"></a><a class="link" href="#_deployment_walkthrough_as_a_platform_engineer">4. Deployment Walkthrough As a Platform Engineer</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a Platform Engineer, so far you have setup</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GatewayAPI with Istio has the provider</p>
</li>
<li>
<p>RHCL Operator</p>
</li>
<li>
<p>Various policies and CRDs including</p>
<div class="ulist">
<ul>
<li>
<p>ManagedZone</p>
</li>
<li>
<p>Gateway (ingress-gateway namespace)</p>
</li>
<li>
<p>DNS Policy (ingress-gateway namespace)</p>
</li>
<li>
<p>TLS Policy (default policy in ingress-gateway namespace)</p>
</li>
<li>
<p>Auth Policy (deny-all default policy in ingress-gateway namespace)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>What is missing now is a default Rate Limit Policy</p>
</div>
<div class="sect2">
<h3 id="_echo_api_walkthrough"><a class="anchor" href="#_echo_api_walkthrough"></a><a class="link" href="#_echo_api_walkthrough">4.1. echo API Walkthrough</a></h3>
<div class="paragraph">
<p>A default HTTPRoute has been created.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check if the HTTPRoute works as it should</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>curl -k -w "%{http_code}" https://echo.%MANAGEDZONE%</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Check how this affects the DNS records created on AWS Route 53</p>
<div class="imageblock">
<div class="content">
<img src="_images/route53-dnsrecords.png" alt="route53 dnsrecords">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_create_default_ratelimit_policy_default_policy_in_ingress_gateway_namespace"><a class="anchor" href="#_create_default_ratelimit_policy_default_policy_in_ingress_gateway_namespace"></a><a class="link" href="#_create_default_ratelimit_policy_default_policy_in_ingress_gateway_namespace">4.2. Create default RateLimit Policy (default policy in ingress-gateway namespace)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">apiVersion: kuadrant.io/v1beta2
kind: RateLimitPolicy
metadata:
  name: ingress-gateway-rlp-lowlimits
  namespace: ingress-gateway
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: prod-web
  limits:
    "default-limits":
      rates:
      - limit: 5
        duration: 10
        unit: second</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The Gateway is now ready for developers to use for connect to their service endpoints.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_service_endpoints_as_a_developer"><a class="anchor" href="#_setup_service_endpoints_as_a_developer"></a><a class="link" href="#_setup_service_endpoints_as_a_developer">5. Setup service-endpoints as a Developer</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_test_globex_mobile"><a class="anchor" href="#_test_globex_mobile"></a><a class="link" href="#_test_globex_mobile">5.1. Test Globex Mobile</a></h3>
<div class="ulist">
<ul>
<li>
<p>Acess the Globex Mobile&#8217;s Route from the <strong>globex-apim-user1</strong> namespace &gt; Routes or click  <a href="https://globex-mobile-globex-apim-user1.%SUBDOMAIN%">here</a></p>
</li>
<li>
<p>Login using <code>asilva/openshift</code> credentials</p>
</li>
<li>
<p>Click on Categories - you should see a 504. This is because the HTTPRoute hasn&#8217;t been created yet</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_httproute_and_backend"><a class="anchor" href="#_set_up_httproute_and_backend"></a><a class="link" href="#_set_up_httproute_and_backend">5.2. Set up HTTPRoute and backend</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
<li>
<p>In this YAML replae the the s`pec &gt; hostnames` as show below</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">kind: HTTPRoute
apiVersion: gateway.networking.k8s.io/v1beta1
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
  labels:
    deployment: globex-mobile-gateway
    service: globex-mobile-gateway
spec:
  parentRefs:
    - kind: Gateway
      namespace: ingress-gateway
      name: prod-web
  hostnames:
    - globex-mobile.%MANAGEDZONE%
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: "/mobile/services/product/category/"
          method: GET
      backendRefs:
        - name: globex-mobile-gateway
          namespace: globex-apim-user1
          port: 8080
    - matches:
        - path:
            type: Exact
            value: "/mobile/services/category/list"
          method: GET
      backendRefs:
        - name: globex-mobile-gateway
          namespace: globex-apim-user1
          port: 8080</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_globex_mobile_again_after_httproute_is_setup"><a class="anchor" href="#_test_globex_mobile_again_after_httproute_is_setup"></a><a class="link" href="#_test_globex_mobile_again_after_httproute_is_setup">5.3. Test Globex Mobile again (after HTTPRoute is setup)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should see a 403.</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-403.png" alt="globex 403" width="70%">
</div>
</div>
</li>
<li>
<p>This is because while you have the HTTPRoute now, the original deny-all default policy kicks in and doesn&#8217;t allow any calls</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_setup_authpolicy"><a class="anchor" href="#_setup_authpolicy"></a><a class="link" href="#_setup_authpolicy">5.4. Setup Authpolicy</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">apiVersion: kuadrant.io/v1beta2
kind: AuthPolicy
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: globex-mobile-gateway
    namespace: globex-apim-user1
  rules:
    authentication:
      "keycloak-users":
        jwt:
          issuerUrl: https://sso.%SUBDOMAIN%/realms/globex-user1
    response:
      success:
        dynamicMetadata:
          identity:
            json:
              properties:
                userid:
                  selector: auth.identity.sub
  routeSelectors:
    - matches: []</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_globex_mobile_again_after_httproute_and_authpolicy_are_setup"><a class="anchor" href="#_test_globex_mobile_again_after_httproute_and_authpolicy_are_setup"></a><a class="link" href="#_test_globex_mobile_again_after_httproute_and_authpolicy_are_setup">5.5. Test Globex Mobile again (after HTTPRoute and AuthPolicy are setup)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should now be able to see the Categories</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-success.png" alt="globex success" width="70%">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_test_the_default_ratelimit_policy"><a class="anchor" href="#_test_the_default_ratelimit_policy"></a><a class="link" href="#_test_the_default_ratelimit_policy">5.6. Test the default <strong>RateLimit Policy</strong></a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should now be able to see the Categories</p>
</li>
<li>
<p>Click any of the Categories from the list, and then the <strong>Categories</strong> menu, and repeat this a few times</p>
</li>
<li>
<p>You would see a 429 error
image::globex-429.png[width=70%]</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_new_ratelimit_policy_which_ovverides_defauly"><a class="anchor" href="#_create_a_new_ratelimit_policy_which_ovverides_defauly"></a><a class="link" href="#_create_a_new_ratelimit_policy_which_ovverides_defauly">5.7. Create a new RateLimit Policy which ovverides defauly</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">apiVersion: kuadrant.io/v1beta2
kind: RateLimitPolicy
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: globex-mobile-gateway
    namespace: globex-apim-user1
  limits:
    "per-user":
      rates:
        - limit: 100
          duration: 10
          unit: second
      counters:
        - metadata.filter_metadata.envoy\.filters\.http\.ext_authz.identity.userid</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_globex_mobile_again_after_httproute_authpolicy_and_ratelimitpolicy_are_setup"><a class="anchor" href="#_test_globex_mobile_again_after_httproute_authpolicy_and_ratelimitpolicy_are_setup"></a><a class="link" href="#_test_globex_mobile_again_after_httproute_authpolicy_and_ratelimitpolicy_are_setup">5.8. Test Globex Mobile again (after HTTPRoute, AuthPolicy and RateLimitPolicy are setup)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should now be able to see the Categories</p>
</li>
<li>
<p>Click any of the Categories from the list, and then the <strong>Categories</strong> menu, and repeat this a few times</p>
</li>
<li>
<p>You would now see there is no 429 for upto 100 request in a duration of 10 seconds</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<h1 id="_conclusion" class="sect0"><a class="anchor" href="#_conclusion"></a><a class="link" href="#_conclusion">Conclusion</a></h1>
<div class="openblock partintro">
<div class="content">
TBC
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-architecture.html" class="query-params-link">2. Architecture</a></span>
  <span class="next"><a href="04-workshop.html" class="query-params-link">4. Workshop</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer" style="justify-content: center;">
  <div>
    <img src="./_images/red_hat_logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns" href="https://redhat.com">
  </div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
